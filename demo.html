<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.37">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Antonio J. Perán">

<title>Demo</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="demo_files/libs/clipboard/clipboard.min.js"></script>
<script src="demo_files/libs/quarto-html/quarto.js"></script>
<script src="demo_files/libs/quarto-html/popper.min.js"></script>
<script src="demo_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="demo_files/libs/quarto-html/anchor.min.js"></script>
<link href="demo_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="demo_files/libs/quarto-html/quarto-syntax-highlighting-29e2c20b02301cfff04dc8050bf30c7e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="demo_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="demo_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="demo_files/libs/bootstrap/bootstrap-ddae12c640c633fda6ef43121ab94794.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">Tabla de contenidos</h2>
   
  <ul>
  <li><a href="#qué-vamos-a-hacer" id="toc-qué-vamos-a-hacer" class="nav-link active" data-scroll-target="#qué-vamos-a-hacer">¿Qué vamos a hacer?</a></li>
  <li><a href="#librerías-necesarias" id="toc-librerías-necesarias" class="nav-link" data-scroll-target="#librerías-necesarias">Librerías necesarias</a></li>
  <li><a href="#obtención-y-preparación-de-los-datos" id="toc-obtención-y-preparación-de-los-datos" class="nav-link" data-scroll-target="#obtención-y-preparación-de-los-datos">Obtención y preparación de los datos</a></li>
  <li><a href="#convertir-los-datos-a-serie-temporal" id="toc-convertir-los-datos-a-serie-temporal" class="nav-link" data-scroll-target="#convertir-los-datos-a-serie-temporal">Convertir los datos a serie temporal</a></li>
  <li><a href="#entrenando-el-modelo" id="toc-entrenando-el-modelo" class="nav-link" data-scroll-target="#entrenando-el-modelo">Entrenando el modelo</a>
  <ul class="collapse">
  <li><a href="#nos-quedamos-con-la-serie-sin-los-últimos-6-datos" id="toc-nos-quedamos-con-la-serie-sin-los-últimos-6-datos" class="nav-link" data-scroll-target="#nos-quedamos-con-la-serie-sin-los-últimos-6-datos">Nos quedamos con la serie sin los últimos 6 datos</a></li>
  <li><a href="#entrenamos-el-modelo-arima" id="toc-entrenamos-el-modelo-arima" class="nav-link" data-scroll-target="#entrenamos-el-modelo-arima">Entrenamos el modelo ARIMA</a></li>
  <li><a href="#calculamos-el-error-que-comete-nuestro-modelo-al-predecir" id="toc-calculamos-el-error-que-comete-nuestro-modelo-al-predecir" class="nav-link" data-scroll-target="#calculamos-el-error-que-comete-nuestro-modelo-al-predecir">Calculamos el error que comete nuestro modelo al predecir</a></li>
  <li><a href="#reentrenamos-el-modelo-con-mismos-hiperparámetros-y-todos-los-datos" id="toc-reentrenamos-el-modelo-con-mismos-hiperparámetros-y-todos-los-datos" class="nav-link" data-scroll-target="#reentrenamos-el-modelo-con-mismos-hiperparámetros-y-todos-los-datos">Reentrenamos el modelo con mismos hiperparámetros y todos los datos</a></li>
  <li><a href="#generamos-los-pronósticos-futuros-de-la-serie" id="toc-generamos-los-pronósticos-futuros-de-la-serie" class="nav-link" data-scroll-target="#generamos-los-pronósticos-futuros-de-la-serie">Generamos los pronósticos futuros de la serie</a></li>
  <li><a href="#calculamos-cuál-va-a-ser-el-incremento-de-la-serie-en-los-próximos-meses" id="toc-calculamos-cuál-va-a-ser-el-incremento-de-la-serie-en-los-próximos-meses" class="nav-link" data-scroll-target="#calculamos-cuál-va-a-ser-el-incremento-de-la-serie-en-los-próximos-meses">Calculamos cuál va a ser el incremento de la serie en los próximos meses</a></li>
  </ul></li>
  <li><a href="#lo-bueno-de-todo-esto" id="toc-lo-bueno-de-todo-esto" class="nav-link" data-scroll-target="#lo-bueno-de-todo-esto">Lo bueno de todo esto</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Demo</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Autor/a</div>
    <div class="quarto-title-meta-contents">
             <p>Antonio J. Perán </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="qué-vamos-a-hacer" class="level1">
<h1>¿Qué vamos a hacer?</h1>
<p>Vamos a crear un procedimiento automático para obtener pronósticos mensuales de precios de acciones con datos procedentes de Yahoo Finanzas, aunque el mismo procedimiento se podría aplicar a cualquier otra serie.</p>
</section>
<section id="librerías-necesarias" class="level1">
<h1>Librerías necesarias</h1>
<p>Deberás tener instalados los siguientes paquetes (y sus dependencias) para seguir la demo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forecast)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(quantmod)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="obtención-y-preparación-de-los-datos" class="level1">
<h1>Obtención y preparación de los datos</h1>
<p>Para obtener los datos, gracias al paquete <code>quantmod</code>, sólo necesitamos conocer el identificador de la acción de la que queremos obtener el histórico de precios. En este <a href="https://stockanalysis.com/stocks/">enlace</a> tenéis una gran lista de identificadores con los que podéis probar.</p>
<p>Elijamos, por ejemplo, las acciones de Apple, cuyo identificador es <code>AAPL</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>datos_yahoo <span class="ot">&lt;-</span> <span class="fu">getSymbols</span>(<span class="st">'AAPL'</span>, <span class="at">src =</span> <span class="st">'yahoo'</span>, <span class="at">auto.assign =</span> <span class="cn">FALSE</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Veamos qué contiene el objeto <code>datos_yahoo</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>datos_yahoo</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            AAPL.Open  AAPL.High   AAPL.Low AAPL.Close AAPL.Volume
2007-01-03   3.081786   3.092143   2.925000   2.992857  1238319600
2007-01-04   3.001786   3.069643   2.993571   3.059286   847260400
2007-01-05   3.063214   3.078571   3.014286   3.037500   834741600
2007-01-08   3.070000   3.090357   3.045714   3.052500   797106800
2007-01-09   3.087500   3.320714   3.041071   3.306071  3349298400
2007-01-10   3.383929   3.492857   3.337500   3.464286  2952880000
2007-01-11   3.426429   3.456429   3.396429   3.421429  1440252800
2007-01-12   3.378214   3.395000   3.329643   3.379286  1312690400
2007-01-16   3.417143   3.473214   3.408929   3.467857  1244076400
2007-01-17   3.484286   3.485714   3.386429   3.391071  1646260000
       ...                                                        
2025-01-13 233.529999 234.669998 229.720001 234.399994    49630700
2025-01-14 234.750000 236.119995 232.470001 233.279999    39435300
2025-01-15 234.639999 238.960007 234.429993 237.869995    39832000
2025-01-16 237.350006 238.009995 228.029999 228.259995    71759100
2025-01-17 232.119995 232.289993 228.479996 229.979996    68488300
2025-01-21 224.000000 224.419998 219.380005 222.639999    98070400
2025-01-22 219.789993 224.119995 219.789993 223.830002    64126500
2025-01-23 224.740005 227.029999 222.300003 223.660004    60234800
2025-01-24 224.779999 225.630005 221.410004 222.779999    54619500
2025-01-27 224.029999 232.149994 224.000000 229.860001    94132139
           AAPL.Adjusted
2007-01-03      2.524615
2007-01-04      2.580652
2007-01-05      2.562274
2007-01-08      2.574927
2007-01-09      2.788827
2007-01-10      2.922289
2007-01-11      2.886137
2007-01-12      2.850587
2007-01-16      2.925301
2007-01-17      2.860528
       ...              
2025-01-13    234.399994
2025-01-14    233.279999
2025-01-15    237.869995
2025-01-16    228.259995
2025-01-17    229.979996
2025-01-21    222.639999
2025-01-22    223.830002
2025-01-23    223.660004
2025-01-24    222.779999
2025-01-27    229.860001</code></pre>
</div>
</div>
<p>Como puedes ver, tiene un histórico diario que va desde 2007 hasta hace unos días. El significado de cada una de las columnas es</p>
<ul>
<li>Open: Precio de la acción cuando se abrió el mercado.</li>
<li>High: Precio más alto que alcanzó la acción ese día.</li>
<li>Low: Precio más bajo que alcanzó la acción ese día.</li>
<li>Close: Precio de la acción cuando se cerró el mercado.</li>
<li>Volume: El volumen de acciones.</li>
<li>Adjusted: Precio de cierre ajustado.</li>
</ul>
<p>Nosotros usaremos el precio de cierre ajustado, es decir, la columna <code>AAPL.Adjusted</code>.</p>
<p>Para ello, convertimos el objeto anterior a <code>data.table</code> y nos quedamos con las columnas 1 y 7, y cambiamos el nombre a otro más genérico.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(datos_yahoo)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> dt[, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>), with <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(dt, <span class="fu">c</span>(<span class="st">"fecha"</span>, <span class="st">"precio"</span>))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>dt</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           fecha     precio
          &lt;Date&gt;      &lt;num&gt;
   1: 2007-01-03   2.524615
   2: 2007-01-04   2.580652
   3: 2007-01-05   2.562274
   4: 2007-01-08   2.574927
   5: 2007-01-09   2.788827
  ---                      
4542: 2025-01-21 222.639999
4543: 2025-01-22 223.830002
4544: 2025-01-23 223.660004
4545: 2025-01-24 222.779999
4546: 2025-01-27 229.860001</code></pre>
</div>
</div>
<p>Nuestro objetivo es obtener pronósticos mensuales, no diarios, por lo que tendremos que tomar medias para cada mes. Para ello definimos las variables mes y año y calculamos medias como sigue</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>dt[, m_y <span class="sc">:</span><span class="er">=</span> <span class="fu">as.yearmon</span>(fecha)]</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> dt[, .(<span class="at">precio =</span> <span class="fu">mean</span>(precio)), .(m_y)]</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>dt</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           m_y     precio
     &lt;yearmon&gt;      &lt;num&gt;
  1:  Jan 2007   2.677705
  2:  Feb 2007   2.582698
  3:  Mar 2007   2.729574
  4:  Apr 2007   2.823021
  5:  May 2007   3.277948
 ---                     
213:  Sep 2024 223.512093
214:  Oct 2024 229.803258
215:  Nov 2024 227.749033
216:  Dec 2024 249.322856
217:  Jan 2025 233.783125</code></pre>
</div>
</div>
<p>Ahora ya podemos, por ejemplo, hacer un gráfico de la serie</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> dt, <span class="fu">aes</span>(<span class="at">x =</span> m_y, <span class="at">y =</span> precio)) <span class="sc">+</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_yearmon</span>() <span class="sc">+</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Precio mensual de las acciones de Apple"</span>, <span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Precio"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="demo_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="convertir-los-datos-a-serie-temporal" class="level1">
<h1>Convertir los datos a serie temporal</h1>
<p>La mayoría de modelos de series temporales con R usan un objeto nativo llamado <code>ts</code>, luego debemos convertir nuestros datos a este tipo de objeto.</p>
<p>Para ello, únicamente necesitamos:</p>
<ul>
<li>Los valores de la serie temporal</li>
<li>Cuándo empieza esta serie temporal: el día, mes, trimestre, …</li>
<li>La frecuencia de la serie, es decir, si es anual, mensual, trimestral, …</li>
</ul>
<p>En nuestro caso, la serie comienza en enero de 2007 y su frecuencia es mensual, luego daremos un 12 a este valor.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>valores_serie <span class="ot">&lt;-</span> dt<span class="sc">$</span>precio</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>empieza <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2007</span>, <span class="dv">1</span>) <span class="co"># c(2007, 1)</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>frecuencia <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>serie_stock <span class="ot">&lt;-</span> <span class="fu">ts</span>(valores_serie, <span class="at">start =</span> empieza, <span class="at">frequency =</span> frecuencia)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>serie_stock</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            Jan        Feb        Mar        Apr        May        Jun
2007   2.677705   2.582698   2.729574   2.823021   3.277948   3.666274
2008   4.831661   3.770445   3.941263   4.765658   5.566192   5.377183
2009   2.674496   2.834144   2.937502   3.615833   3.860704   4.203522
2010   6.257772   5.989058   6.730629   7.566274   7.575702   7.867448
2011  10.194268  10.579969  10.468748  10.255591  10.296842   9.974384
2012  12.911635  14.990166  17.398394  18.256862  17.011731  17.309660
2013  15.130926  13.948388  13.507684  12.832789  13.714011  13.095388
2014  16.745610  16.490317  16.713217  16.959581  18.987558  20.273182
2015  24.639236  28.026753  28.163723  28.458956  28.884130  28.693536
2016  22.293041  21.785516  23.743501  24.306367  21.740423  22.136561
2017  27.683785  31.051569  32.698097  33.225715  35.491659  34.517362
2018  40.934914  39.549440  41.217779  40.116591  43.934444  44.726109
2019  36.812253  41.135351  43.955140  48.085189  45.984683  46.453525
2020  75.599325  75.583306  63.759704  66.175092  75.464749  84.239639
2021 130.090743 128.769443 119.350544 129.086470 124.329423 127.486779
2022 167.123895 167.271258 162.853396 164.341502 146.395033 137.923060
2023 134.366019 149.541184 153.586283 163.577617 171.227995 182.896663
2024 186.809099 184.037743 172.073872 168.993062 185.788819 205.798268
2025 233.783125                                                       
            Jul        Aug        Sep        Oct        Nov        Dec
2007   4.100271   3.911754   4.280400   5.176079   5.261870   5.739284
2008   5.053711   5.153757   4.255193   2.982660   2.830117   2.757906
2009   4.498462   5.009480   5.356123   5.809370   6.034978   5.993841
2010   7.680799   7.571535   8.250222   9.066153   9.387116   9.685305
2011  11.214297  11.350608  11.824523  11.967223  11.593208  11.837693
2012  18.108190  19.424663  20.621559  19.203938  17.137447  16.171399
2013  13.206767  14.997542  14.874633  15.635434  16.331662  17.437685
2014  21.098462  21.806692  22.294922  22.550135  25.211445  25.033373
2015  28.138701  25.556299  25.438494  25.565323  26.744814  25.304859
2016  22.579698  24.783100  25.535411  26.652586  25.491222  26.471903
2017  34.626665  37.232110  36.944753  36.993692  40.510236  40.437656
2018  45.126845  50.713869  52.843024  52.550810  45.622506  39.223988
2019  49.401837  49.476933  52.677435  56.855846  63.589980  67.021712
2020  93.121092 114.467585 112.381901 113.639155 114.200726 124.471608
2021 142.378919 145.537911 145.703331 143.009078 151.728551 170.755617
2022 147.662554 164.836090 151.159879 143.266590 144.291704 136.441855
2023 190.963670 179.877997 175.907835 173.588407 184.895114 193.361219
2024 224.092422 221.316174 223.512093 229.803258 227.749033 249.322856
2025                                                                  </code></pre>
</div>
</div>
</section>
<section id="entrenando-el-modelo" class="level1">
<h1>Entrenando el modelo</h1>
<section id="nos-quedamos-con-la-serie-sin-los-últimos-6-datos" class="level2">
<h2 class="anchored" data-anchor-id="nos-quedamos-con-la-serie-sin-los-últimos-6-datos">Nos quedamos con la serie sin los últimos 6 datos</h2>
<p>Como ya comentamos en el caso de uso de forecasting, necesitamos quitar algún valor a la serie, en este caso 6, para evaluar qué tal hace las predicciones, para ello cogemos la serie original menos los últimos 6 valores usando la función <code>head</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>serie_stock_train <span class="ot">&lt;-</span> utils<span class="sc">::</span><span class="fu">head</span>(serie_stock, <span class="sc">-</span><span class="dv">6</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>serie_stock_train</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            Jan        Feb        Mar        Apr        May        Jun
2007   2.677705   2.582698   2.729574   2.823021   3.277948   3.666274
2008   4.831661   3.770445   3.941263   4.765658   5.566192   5.377183
2009   2.674496   2.834144   2.937502   3.615833   3.860704   4.203522
2010   6.257772   5.989058   6.730629   7.566274   7.575702   7.867448
2011  10.194268  10.579969  10.468748  10.255591  10.296842   9.974384
2012  12.911635  14.990166  17.398394  18.256862  17.011731  17.309660
2013  15.130926  13.948388  13.507684  12.832789  13.714011  13.095388
2014  16.745610  16.490317  16.713217  16.959581  18.987558  20.273182
2015  24.639236  28.026753  28.163723  28.458956  28.884130  28.693536
2016  22.293041  21.785516  23.743501  24.306367  21.740423  22.136561
2017  27.683785  31.051569  32.698097  33.225715  35.491659  34.517362
2018  40.934914  39.549440  41.217779  40.116591  43.934444  44.726109
2019  36.812253  41.135351  43.955140  48.085189  45.984683  46.453525
2020  75.599325  75.583306  63.759704  66.175092  75.464749  84.239639
2021 130.090743 128.769443 119.350544 129.086470 124.329423 127.486779
2022 167.123895 167.271258 162.853396 164.341502 146.395033 137.923060
2023 134.366019 149.541184 153.586283 163.577617 171.227995 182.896663
2024 186.809099 184.037743 172.073872 168.993062 185.788819 205.798268
            Jul        Aug        Sep        Oct        Nov        Dec
2007   4.100271   3.911754   4.280400   5.176079   5.261870   5.739284
2008   5.053711   5.153757   4.255193   2.982660   2.830117   2.757906
2009   4.498462   5.009480   5.356123   5.809370   6.034978   5.993841
2010   7.680799   7.571535   8.250222   9.066153   9.387116   9.685305
2011  11.214297  11.350608  11.824523  11.967223  11.593208  11.837693
2012  18.108190  19.424663  20.621559  19.203938  17.137447  16.171399
2013  13.206767  14.997542  14.874633  15.635434  16.331662  17.437685
2014  21.098462  21.806692  22.294922  22.550135  25.211445  25.033373
2015  28.138701  25.556299  25.438494  25.565323  26.744814  25.304859
2016  22.579698  24.783100  25.535411  26.652586  25.491222  26.471903
2017  34.626665  37.232110  36.944753  36.993692  40.510236  40.437656
2018  45.126845  50.713869  52.843024  52.550810  45.622506  39.223988
2019  49.401837  49.476933  52.677435  56.855846  63.589980  67.021712
2020  93.121092 114.467585 112.381901 113.639155 114.200726 124.471608
2021 142.378919 145.537911 145.703331 143.009078 151.728551 170.755617
2022 147.662554 164.836090 151.159879 143.266590 144.291704 136.441855
2023 190.963670 179.877997 175.907835 173.588407 184.895114 193.361219
2024 224.092422                                                       </code></pre>
</div>
</div>
</section>
<section id="entrenamos-el-modelo-arima" class="level2">
<h2 class="anchored" data-anchor-id="entrenamos-el-modelo-arima">Entrenamos el modelo ARIMA</h2>
<p>Entrenamos un modelo ARIMA con la función <code>auto.arima</code>, que es un procedimiento automático que hace la selección de el mejor modelo ARIMA posible y todos los ajustes por nosotros. Si tenéis más interes en modelos de series temporales con R, os recomiento empezar por <a href="https://otexts.com/fpp3/">este libro</a> o cualquiera de sus ediciones, que es del autor de <code>auto.arima</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>arima_train <span class="ot">&lt;-</span> <span class="fu">auto.arima</span>(serie_stock_train)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ahora podemos representar fácilmente la serie temporal junto con la predicciones para los 6 últimos meses que nos da <code>auto.arima</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>pron_ult_6m <span class="ot">&lt;-</span> <span class="fu">forecast</span>(arima_train, <span class="dv">6</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>pron_ult_6m</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         Point Forecast    Lo 80    Hi 80    Lo 95    Hi 95
Aug 2024       230.3275 224.0619 236.5932 220.7451 239.9100
Sep 2024       232.7125 222.1859 243.2391 216.6134 248.8116
Oct 2024       235.0975 221.4826 248.7124 214.2753 255.9197
Nov 2024       237.4825 221.2656 253.6994 212.6809 262.2841
Dec 2024       239.8675 221.3273 258.4077 211.5127 268.2222
Jan 2025       242.2525 221.5721 262.9328 210.6246 273.8804</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(pron_ult_6m) <span class="sc">+</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">2022</span>, <span class="cn">NA</span>)) <span class="sc">+</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Precio mensual de las acciones de Apple"</span>, </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Preddicciones realizadas con auto.arima"</span>,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="cn">NULL</span>, </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Precio"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="demo_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="calculamos-el-error-que-comete-nuestro-modelo-al-predecir" class="level2">
<h2 class="anchored" data-anchor-id="calculamos-el-error-que-comete-nuestro-modelo-al-predecir">Calculamos el error que comete nuestro modelo al predecir</h2>
<p>La métrica de error que usaremos será el <em>MAPE</em>, cuya fórmula viene dada por</p>
<p><span class="math display">\[\text{MAPE} = \frac{1}{n}\sum_{i=1}^{n}\left\lvert\frac{A_i - F_i}{A_i}\right\lvert\]</span></p>
<p>es útil, por tanto, crear una función propia que lo calcule</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Función que calcula el MAPE</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param y_pred Valores pronosticados por el modelo.</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param y_true Valores originales de la serie.</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return Un número que es el MAPE sobre 1, no en porcentaje.</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>funcion_mape <span class="ot">&lt;-</span> <span class="cf">function</span>(y_pred, y_true){</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(<span class="fu">abs</span>(y_true <span class="sc">-</span> y_pred)<span class="sc">/</span>y_true)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Debemos entonces obtener <code>y_pred</code> e <code>y_true</code>.</p>
<p><code>y_true</code> es muy sencillo, pues son los últimos 6 valores de la serie original. Una forma rápida de hacerlo sin subíndices es la siguiente</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>y_true <span class="ot">&lt;-</span> utils<span class="sc">::</span><span class="fu">tail</span>(serie_stock, <span class="dv">6</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para calcular <code>y_pred</code> usamos los pronósticos que obtuvimos en el paso anterior</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>y_pred <span class="ot">&lt;-</span> pron_ult_6m<span class="sc">$</span>mean</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finalmente el MAPE resultaría</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>arima_mape <span class="ot">&lt;-</span> <span class="fu">funcion_mape</span>(y_pred, y_true)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>arima_mape</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.03696791</code></pre>
</div>
</div>
</section>
<section id="reentrenamos-el-modelo-con-mismos-hiperparámetros-y-todos-los-datos" class="level2">
<h2 class="anchored" data-anchor-id="reentrenamos-el-modelo-con-mismos-hiperparámetros-y-todos-los-datos">Reentrenamos el modelo con mismos hiperparámetros y todos los datos</h2>
<p>Una vez sabemos cuánto se equivoca el modelo, debemos reentrenarlo o reajustarlo para usar todos los datos disponibles (añadiendo los 6 valores que quitamos en un inicio). Hacer esto no tiene por qué ser sencillo, pero en caso de <code>auto.arima</code> sí que lo es, sólo basta con indicarle a la función <code>Arima</code> el modelo anterior y los datos completos.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>refit_arima <span class="ot">&lt;-</span> <span class="fu">Arima</span>(serie_stock, <span class="at">model =</span> arima_train)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="generamos-los-pronósticos-futuros-de-la-serie" class="level2">
<h2 class="anchored" data-anchor-id="generamos-los-pronósticos-futuros-de-la-serie">Generamos los pronósticos futuros de la serie</h2>
<p>Ahora, al igual que hicimos antes, con la función <code>forecast</code>, repetimos para dar pronósticos futuros de la serie y podemos pintarlos también.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>pron_prox_6m <span class="ot">&lt;-</span> <span class="fu">forecast</span>(refit_arima, <span class="dv">6</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>pron_prox_6m</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         Point Forecast    Lo 80    Hi 80    Lo 95    Hi 95
Feb 2025       227.7449 221.4792 234.0105 218.1624 237.3273
Mar 2025       229.7867 219.2601 240.3133 213.6876 245.8858
Apr 2025       231.8285 218.2136 245.4434 211.0063 252.6507
May 2025       233.8703 217.6534 250.0872 209.0687 258.6719
Jun 2025       235.9121 217.3720 254.4522 207.5574 264.2668
Jul 2025       237.9539 217.2736 258.6342 206.3261 269.5817</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(pron_prox_6m) <span class="sc">+</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">2021</span>, <span class="cn">NA</span>)) <span class="sc">+</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Precio mensual de las acciones de Apple"</span>, </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Preddicciones realizadas con auto.arima"</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="cn">NULL</span>, </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Precio"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="demo_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="calculamos-cuál-va-a-ser-el-incremento-de-la-serie-en-los-próximos-meses" class="level2">
<h2 class="anchored" data-anchor-id="calculamos-cuál-va-a-ser-el-incremento-de-la-serie-en-los-próximos-meses">Calculamos cuál va a ser el incremento de la serie en los próximos meses</h2>
<p>Como ocurría con el MAPE, aquí también es conveniente crear una función que nos calcule el incremento entre dos valores.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Función que calcula el incremento</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x0 Valor numérico, más reciente.</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x1 Valor numérico, más tardío.</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return El incremento (sobre 1) entre los dos valores especificados</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>funcion_incremento <span class="ot">&lt;-</span> <span class="cf">function</span>(x0, x1){</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  x1<span class="sc">/</span>x0 <span class="sc">-</span> <span class="dv">1</span> <span class="co"># ( (x1 - x0)/x0 )</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>En nuestro caso, calcularemos el incremento entre el último valor de la serie conocido y el último valor pronosticado.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>x0 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">tail</span>(serie_stock, <span class="dv">1</span>))</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">tail</span>(pron_prox_6m<span class="sc">$</span>mean, <span class="dv">1</span>))</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>inc <span class="ot">&lt;-</span> <span class="fu">funcion_incremento</span>(x0, x1)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Luego pronosticamos que la serie de stock mensual de APPLE tendrá un incremento percentual del 1.78 % en los próximos 6 meses con un MAPE en test del 3.7 %.</p>
</section>
</section>
<section id="lo-bueno-de-todo-esto" class="level1">
<h1>Lo bueno de todo esto</h1>
<p>Gracias a que R es un lenguaje de programación, hemos creado un procedimiento reproducible y reutilizable todas las veces que queramos. Para repetir este análisis para otra serie de Stock, lo único que tenemos que cambiar es el input, el identificador de la acción.</p>
<p>Es decir, cambiando en la línea 38 <code>AAPL</code> por cualquier otro identificador, por ejemplo, <code>MSFT</code> que es Microsoft, se repetiría todo el proceso de un plumazo!</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copiado");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copiado");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>